{% extends "base.html" %}

{% block title %}Salary Cap Management - NFL GM Simulator{% endblock %}

{% block content %}
<div class="salary-cap-page">
    <h2>Salary Cap Management</h2>
    
    <div class="cap-controls">
        <div class="team-selector">
            <label for="cap-team-select">Select Team:</label>
            <select id="cap-team-select">
                <option value="">Loading teams...</option>
            </select>
        </div>
        
        <div class="view-controls">
            <button class="btn btn-primary" onclick="showCapOverview()">Cap Overview</button>
            <button class="btn btn-secondary" onclick="showContracts()">Contracts</button>
            <button class="btn btn-secondary" onclick="showCapTools()">Cap Tools</button>
            <button class="btn btn-secondary" onclick="showLeagueOverview()">League Overview</button>
        </div>
    </div>
    
    <div class="cap-content">
        <!-- Cap Overview View -->
        <div id="cap-overview-view" class="cap-view active">
            <h3>Salary Cap Overview</h3>
            <div id="cap-overview-content">
                <p>Select a team to view cap overview</p>
            </div>
        </div>
        
        <!-- Contracts View -->
        <div id="contracts-view" class="cap-view">
            <h3>Team Contracts</h3>
            <div id="contracts-content">
                <p>Select a team to view contracts</p>
            </div>
        </div>
        
        <!-- Cap Tools View -->
        <div id="cap-tools-view" class="cap-view">
            <h3>Cap Management Tools</h3>
            <div id="cap-tools-content">
                <p>Select a team to access cap tools</p>
            </div>
        </div>
        
        <!-- League Overview View -->
        <div id="league-overview-view" class="cap-view">
            <h3>League Salary Cap Overview</h3>
            <div id="league-overview-content">
                <div class="loading">Loading league data...</div>
            </div>
        </div>
    </div>
</div>

<style>
.salary-cap-page {
    padding: 1rem;
}

.cap-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
    padding: 1rem;
    background: var(--bg-secondary);
    border-radius: 8px;
}

.team-selector {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.team-selector label {
    font-weight: 500;
    color: var(--text-secondary);
}

.team-selector select {
    padding: 0.5rem;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    min-width: 200px;
}

.view-controls {
    display: flex;
    gap: 0.5rem;
}

.btn {
    padding: 0.5rem 1rem;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-weight: 500;
    transition: all 0.2s;
}

.btn-primary {
    background: var(--accent-color);
    color: white;
}

.btn-primary:hover {
    background: #2c5aa0;
}

.btn-secondary {
    background: var(--bg-tertiary);
    color: var(--text-primary);
    border: 1px solid var(--border-color);
}

.btn-secondary:hover {
    background: var(--border-color);
}

.cap-view {
    display: none;
}

.cap-view.active {
    display: block;
}

/* Cap Overview Styles */
.cap-summary-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
}

.cap-summary-card {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 1.5rem;
    text-align: center;
}

.cap-summary-card h4 {
    margin: 0 0 1rem 0;
    color: var(--text-secondary);
    font-size: 0.9rem;
    text-transform: uppercase;
}

.cap-value {
    font-size: 2rem;
    font-weight: bold;
    color: var(--accent-color);
}

.cap-percentage {
    font-size: 1.2rem;
    font-weight: 500;
    color: var(--text-primary);
}

.cap-health {
    padding: 0.5rem 1rem;
    border-radius: 4px;
    font-weight: 500;
    margin-top: 0.5rem;
}

.cap-health.excellent { background: var(--success-color); color: white; }
.cap-health.good { background: #4CAF50; color: white; }
.cap-health.fair { background: var(--warning-color); color: white; }
.cap-health.critical { background: var(--error-color); color: white; }

/* Contracts Styles */
.contracts-summary {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 1.5rem;
    margin-bottom: 2rem;
}

.contracts-summary h4 {
    margin: 0 0 1rem 0;
    color: var(--text-primary);
}

.contracts-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
}

.contract-stat {
    text-align: center;
    padding: 1rem;
    background: var(--bg-secondary);
    border-radius: 4px;
}

.contract-stat-value {
    font-size: 1.5rem;
    font-weight: bold;
    color: var(--accent-color);
}

.contract-stat-label {
    font-size: 0.8rem;
    color: var(--text-secondary);
    text-transform: uppercase;
}

.contracts-list {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 1.5rem;
}

.contract-item {
    display: grid;
    grid-template-columns: 1fr auto auto auto auto;
    gap: 1rem;
    padding: 1rem;
    border-bottom: 1px solid var(--bg-secondary);
    align-items: center;
}

.contract-item:last-child {
    border-bottom: none;
}

.contract-header {
    font-weight: bold;
    color: var(--text-secondary);
    text-transform: uppercase;
    font-size: 0.8rem;
    padding: 1rem;
    background: var(--bg-secondary);
    border-radius: 8px;
    margin-bottom: 1rem;
}

/* Cap Tools Styles */
.cap-tools-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1rem;
}

.cap-tool-card {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 1.5rem;
}

.cap-tool-card h4 {
    margin: 0 0 1rem 0;
    color: var(--text-primary);
}

.tool-form {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.form-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.form-group label {
    font-weight: 500;
    color: var(--text-secondary);
}

.form-group input, .form-group select {
    padding: 0.5rem;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    background: var(--bg-primary);
    color: var(--text-primary);
}

.tool-result {
    margin-top: 1rem;
    padding: 1rem;
    background: var(--bg-secondary);
    border-radius: 4px;
    display: none;
}

.tool-result.success {
    background: var(--success-color);
    color: white;
}

.tool-result.error {
    background: var(--error-color);
    color: white;
}

/* League Overview Styles */
.league-overview-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1rem;
}

.team-cap-card {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 1rem;
}

.team-cap-card h4 {
    margin: 0 0 0.5rem 0;
    color: var(--text-primary);
    font-size: 1rem;
}

.team-cap-stats {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0.5rem;
}

.team-cap-stat {
    text-align: center;
    padding: 0.5rem;
    background: var(--bg-secondary);
    border-radius: 4px;
}

.team-cap-value {
    font-size: 1.1rem;
    font-weight: bold;
    color: var(--accent-color);
}

.team-cap-label {
    font-size: 0.7rem;
    color: var(--text-secondary);
    text-transform: uppercase;
}

.loading {
    text-align: center;
    padding: 2rem;
    color: var(--text-muted);
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Load teams into selector
    loadTeams();
    
    // Set up team selection handler
    document.getElementById('cap-team-select').addEventListener('change', function() {
        const teamId = this.value;
        if (teamId) {
            loadTeamCapData(teamId);
        }
    });
    
    // Load league overview by default
    loadLeagueOverview();
});

function loadTeams() {
    fetch('/api/teams')
        .then(response => response.json())
        .then(teams => {
            const select = document.getElementById('cap-team-select');
            select.innerHTML = '<option value="">Select a team...</option>';
            
            teams.forEach(team => {
                const option = document.createElement('option');
                option.value = team.id;
                option.textContent = `${team.city} ${team.name}`;
                select.appendChild(option);
            });
        });
}

function loadTeamCapData(teamId) {
    // Load cap overview
    fetch(`/api/salary-cap/team/${teamId}/summary`)
        .then(response => response.json())
        .then(data => {
            displayCapOverview(data);
        });
    
    // Load contracts
    fetch(`/api/salary-cap/team/${teamId}/contracts`)
        .then(response => response.json())
        .then(data => {
            displayContracts(data);
        });
    
    // Load cap tools
    loadCapTools(teamId);
}

function displayCapOverview(capData) {
    const content = document.getElementById('cap-overview-content');
    
    if (capData.error) {
        content.innerHTML = `<p class="error">${capData.error}</p>`;
        return;
    }
    
    const healthClass = capData.cap_efficiency.health_status.toLowerCase();
    
    let html = `
        <div class="cap-summary-grid">
            <div class="cap-summary-card">
                <h4>Adjusted Cap</h4>
                <div class="cap-value">$${(capData.adjusted_cap / 1000000).toFixed(1)}M</div>
            </div>
            <div class="cap-summary-card">
                <h4>Cap Used</h4>
                <div class="cap-value">$${(capData.total_cap_used / 1000000).toFixed(1)}M</div>
                <div class="cap-percentage">${capData.cap_percentage.toFixed(1)}%</div>
            </div>
            <div class="cap-summary-card">
                <h4>Cap Space</h4>
                <div class="cap-value">$${(capData.cap_space / 1000000).toFixed(1)}M</div>
            </div>
            <div class="cap-summary-card">
                <h4>Dead Money</h4>
                <div class="cap-value">$${(capData.dead_money / 1000000).toFixed(1)}M</div>
            </div>
            <div class="cap-summary-card">
                <h4>Cap Health</h4>
                <div class="cap-health ${healthClass}">${capData.cap_efficiency.health_status}</div>
                <div class="cap-percentage">${capData.cap_efficiency.utilization_percentage}%</div>
            </div>
            <div class="cap-summary-card">
                <h4>Flexibility</h4>
                <div class="cap-percentage">${capData.cap_efficiency.flexibility}</div>
            </div>
        </div>
        
        <div class="cap-summary-card" style="grid-column: 1 / -1;">
            <h4>Top Contracts</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                ${capData.top_contracts.map(contract => `
                    <div style="text-align: center; padding: 1rem; background: var(--bg-secondary); border-radius: 4px;">
                        <div style="font-weight: bold;">$${(contract.cap_hit / 1000000).toFixed(1)}M</div>
                        <div style="font-size: 0.8rem; color: var(--text-secondary);">${contract.contract_type}</div>
                    </div>
                `).join('')}
            </div>
        </div>
    `;
    
    content.innerHTML = html;
}

function displayContracts(contractsData) {
    const content = document.getElementById('contracts-content');
    
    if (contractsData.error) {
        content.innerHTML = `<p class="error">${contractsData.error}</p>`;
        return;
    }
    
    let html = `
        <div class="contracts-summary">
            <h4>Contracts Summary</h4>
            <div class="contracts-stats">
                <div class="contract-stat">
                    <div class="contract-stat-value">${contractsData.total_contracts}</div>
                    <div class="contract-stat-label">Total Contracts</div>
                </div>
                <div class="contract-stat">
                    <div class="contract-stat-value">$${(contractsData.total_value / 1000000).toFixed(1)}M</div>
                    <div class="contract-stat-label">Total Value</div>
                </div>
                <div class="contract-stat">
                    <div class="contract-stat-value">$${(contractsData.total_guaranteed / 1000000).toFixed(1)}M</div>
                    <div class="contract-stat-label">Guaranteed Money</div>
                </div>
                <div class="contract-stat">
                    <div class="contract-stat-value">${contractsData.guaranteed_percentage.toFixed(1)}%</div>
                    <div class="contract-stat-label">Guaranteed %</div>
                </div>
            </div>
        </div>
        
        <div class="contracts-list">
            <h4>Contract Breakdown by Type</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                ${Object.entries(contractsData.contract_types).map(([type, data]) => `
                    <div style="text-align: center; padding: 1rem; background: var(--bg-secondary); border-radius: 4px;">
                        <div style="font-weight: bold;">${type}</div>
                        <div style="font-size: 1.2rem; color: var(--accent-color);">${data.count}</div>
                        <div style="font-size: 0.8rem; color: var(--text-secondary);">$${(data.total_value / 1000000).toFixed(1)}M</div>
                    </div>
                `).join('')}
            </div>
        </div>
    `;
    
    content.innerHTML = html;
}

function loadCapTools(teamId) {
    const content = document.getElementById('cap-tools-content');
    
    content.innerHTML = `
        <div class="cap-tools-grid">
            <div class="cap-tool-card">
                <h4>Contract Extension</h4>
                <form class="tool-form" onsubmit="extendContract(event, ${teamId})">
                    <div class="form-group">
                        <label>Player ID:</label>
                        <input type="number" id="extend-player-id" required>
                    </div>
                    <div class="form-group">
                        <label>Base Salary ($):</label>
                        <input type="number" id="extend-base-salary" required>
                    </div>
                    <div class="form-group">
                        <label>Years:</label>
                        <input type="number" id="extend-years" min="1" max="5" required>
                    </div>
                    <div class="form-group">
                        <label>Signing Bonus ($):</label>
                        <input type="number" id="extend-signing-bonus" value="0">
                    </div>
                    <button type="submit" class="btn btn-primary">Negotiate Extension</button>
                </form>
                <div id="extend-result" class="tool-result"></div>
            </div>
            
            <div class="cap-tool-card">
                <h4>Contract Restructure</h4>
                <form class="tool-form" onsubmit="restructureContract(event)">
                    <div class="form-group">
                        <label>Contract ID:</label>
                        <input type="number" id="restructure-contract-id" required>
                    </div>
                    <div class="form-group">
                        <label>Restructure Amount ($):</label>
                        <input type="number" id="restructure-amount" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Restructure Contract</button>
                </form>
                <div id="restructure-result" class="tool-result"></div>
            </div>
            
            <div class="cap-tool-card">
                <h4>Release Player</h4>
                <form class="tool-form" onsubmit="releasePlayer(event)">
                    <div class="form-group">
                        <label>Contract ID:</label>
                        <input type="number" id="release-contract-id" required>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="post-june-1">
                            Post-June 1 Release
                        </label>
                    </div>
                    <button type="submit" class="btn btn-primary">Release Player</button>
                </form>
                <div id="release-result" class="tool-result"></div>
            </div>
        </div>
    `;
}

function loadLeagueOverview() {
    fetch('/api/salary-cap/league/overview')
        .then(response => response.json())
        .then(data => {
            displayLeagueOverview(data);
        });
}

function displayLeagueOverview(data) {
    const content = document.getElementById('league-overview-content');
    
    let html = `
        <div class="cap-summary-card" style="grid-column: 1 / -1; margin-bottom: 2rem;">
            <h4>League Salary Cap: $${(data.salary_cap.base_cap / 1000000).toFixed(1)}M</h4>
        </div>
        
        <div class="league-overview-grid">
            ${data.teams.map(team => `
                <div class="team-cap-card">
                    <h4>${team.team_name}</h4>
                    <div class="team-cap-stats">
                        <div class="team-cap-stat">
                            <div class="team-cap-value">$${(team.cap_used / 1000000).toFixed(1)}M</div>
                            <div class="team-cap-label">Used</div>
                        </div>
                        <div class="team-cap-stat">
                            <div class="team-cap-value">$${(team.cap_space / 1000000).toFixed(1)}M</div>
                            <div class="team-cap-label">Space</div>
                        </div>
                        <div class="team-cap-stat">
                            <div class="team-cap-value">${team.cap_percentage.toFixed(1)}%</div>
                            <div class="team-cap-label">Used %</div>
                        </div>
                    </div>
                </div>
            `).join('')}
        </div>
    `;
    
    content.innerHTML = html;
}

// Cap Tool Functions
function extendContract(event, teamId) {
    event.preventDefault();
    
    const playerId = document.getElementById('extend-player-id').value;
    const baseSalary = document.getElementById('extend-base-salary').value;
    const years = document.getElementById('extend-years').value;
    const signingBonus = document.getElementById('extend-signing-bonus').value;
    
    fetch(`/api/salary-cap/player/${playerId}/extend?team_id=${teamId}&base_salary=${baseSalary}&years=${years}&signing_bonus=${signingBonus}`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(result => {
        const resultDiv = document.getElementById('extend-result');
        resultDiv.style.display = 'block';
        
        if (result.success) {
            resultDiv.className = 'tool-result success';
            resultDiv.innerHTML = `
                <strong>Success!</strong> ${result.message}<br>
                Contract ID: ${result.contract_id}<br>
                Total Value: $${(result.total_value / 1000000).toFixed(1)}M<br>
                Year 1 Cap Hit: $${(result.cap_hit_year_1 / 1000000).toFixed(1)}M
            `;
        } else {
            resultDiv.className = 'tool-result error';
            resultDiv.innerHTML = `<strong>Failed:</strong> ${result.message}`;
        }
    });
}

function restructureContract(event) {
    event.preventDefault();
    
    const contractId = document.getElementById('restructure-contract-id').value;
    const amount = document.getElementById('restructure-amount').value;
    
    fetch(`/api/salary-cap/contract/${contractId}/restructure?restructure_amount=${amount}`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(result => {
        const resultDiv = document.getElementById('restructure-result');
        resultDiv.style.display = 'block';
        
        if (result.success) {
            resultDiv.className = 'tool-result success';
            resultDiv.innerHTML = `
                <strong>Success!</strong> Contract restructured<br>
                Cap Savings: $${(result.cap_savings / 1000000).toFixed(1)}M<br>
                New Cap Hit: $${(result.new_cap_hit / 1000000).toFixed(1)}M
            `;
        } else {
            resultDiv.className = 'tool-result error';
            resultDiv.innerHTML = `<strong>Failed:</strong> ${result.error}`;
        }
    });
}

function releasePlayer(event) {
    event.preventDefault();
    
    const contractId = document.getElementById('release-contract-id').value;
    const postJune1 = document.getElementById('post-june-1').checked;
    
    fetch(`/api/salary-cap/contract/${contractId}/release?post_june_1=${postJune1}`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(result => {
        const resultDiv = document.getElementById('release-result');
        resultDiv.style.display = 'block';
        
        if (result.success) {
            resultDiv.className = 'tool-result success';
            resultDiv.innerHTML = `
                <strong>Success!</strong> Player released<br>
                Cap Savings: $${(result.cap_savings / 1000000).toFixed(1)}M<br>
                Dead Money: $${(result.dead_money_current / 1000000).toFixed(1)}M
            `;
        } else {
            resultDiv.className = 'tool-result error';
            resultDiv.innerHTML = `<strong>Failed:</strong> ${result.error}`;
        }
    });
}

// View Control Functions
function showCapOverview() {
    showView('cap-overview-view');
}

function showContracts() {
    showView('contracts-view');
}

function showCapTools() {
    showView('cap-tools-view');
}

function showLeagueOverview() {
    showView('league-overview-view');
}

function showView(viewId) {
    // Hide all views
    document.querySelectorAll('.cap-view').forEach(view => {
        view.classList.remove('active');
    });
    
    // Show selected view
    document.getElementById(viewId).classList.add('active');
    
    // Update button states
    document.querySelectorAll('.btn').forEach(btn => {
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-secondary');
    });
    
    // Highlight active button
    event.target.classList.remove('btn-secondary');
    event.target.classList.add('btn-primary');
}
</script>
{% endblock %}
